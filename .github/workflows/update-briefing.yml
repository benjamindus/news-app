name: Update Morning Briefing

on:
  schedule:
    - cron: '0 14 * * *'  # Daily 6:00 AM PST (UTC-8)
  workflow_dispatch:       # Manual trigger

permissions:
  contents: write

jobs:
  update-briefing:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Cache Kokoro TTS models
        id: cache-kokoro
        uses: actions/cache@v4
        with:
          path: |
            kokoro-v1.0.onnx
            voices-v1.0.bin
          key: kokoro-models-v1.0

      - name: Download Kokoro TTS models
        if: steps.cache-kokoro.outputs.cache-hit != 'true'
        run: |
          curl -fSL -o kokoro-v1.0.onnx "https://github.com/thewh1teagle/kokoro-onnx/releases/download/model-files-v1.0/kokoro-v1.0.onnx"
          curl -fSL -o voices-v1.0.bin "https://github.com/thewh1teagle/kokoro-onnx/releases/download/model-files-v1.0/voices-v1.0.bin"

      - name: Install Python TTS dependencies
        run: pip install kokoro-onnx soundfile pydub

      - name: Install ffmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Run update briefing
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: bash update-briefing.sh

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add morning_briefing.md morning_briefing.html audio/*.mp3
          git diff --staged --quiet || git commit -m "Morning briefing update $(date +%Y-%m-%d)"
          git push
